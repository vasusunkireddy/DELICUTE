<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Promotions Management | DELICUTE</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root {
      --primary-teal: #26a69a;
      --secondary-teal: #4dd0e1;
      --gold: #ffd700;
      --gold-light: #ffca28;
      --dark: #1a1a1a;
      --text-light: #fff3cd;
      --error-red: #ff5252;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Playfair Display', serif;
      background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
      color: var(--dark);
      min-height: 100vh;
      line-height: 1.6;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    header {
      background: linear-gradient(90deg, var(--primary-teal), var(--secondary-teal));
      color: white;
      padding: 1.5rem 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: var(--shadow-md);
      position: relative;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.3), transparent);
      animation: shine 3s infinite;
    }

    header img {
      height: 60px;
      filter: drop-shadow(0 3px 8px rgba(0, 0, 0, 0.2));
      transition: transform 0.3s ease;
    }

    header img:hover {
      transform: scale(1.1);
    }

    header h1 {
      font-size: 2.2rem;
      font-weight: 800;
      margin-top: 0.5rem;
      text-shadow: 0 2px 6px rgba(255, 215, 0, 0.4);
    }

    header span {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-light);
    }

    nav {
      background: var(--dark);
      display: flex;
      justify-content: center;
      box-shadow: var(--shadow-sm);
    }

    nav a {
      flex: 0 1 150px;
      padding: 1rem;
      text-align: center;
      color: white;
      text-decoration: none;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    nav a:hover {
      background: var(--primary-teal);
      color: var(--text-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .logout {
      background: linear-gradient(45deg, var(--gold), var(--gold-light));
      border: none;
      padding: 0.6rem 1.5rem;
      color: var(--dark);
      font-weight: 700;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      position: absolute;
      top: 1rem;
      right: 1rem;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    .logout:hover {
      background: linear-gradient(45deg, var(--gold-light), #ffb300);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .content {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: var(--shadow-md);
    }

    .content h2 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-teal);
      margin-bottom: 1rem;
      text-align: center;
    }

    .form-container {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-size: 1rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.5rem;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      font-family: 'Playfair Display', serif;
      transition: border-color 0.2s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      border-color: var(--primary-teal);
      outline: none;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .submit-btn {
      background: linear-gradient(45deg, var(--primary-teal), var(--secondary-teal));
      border: none;
      padding: 0.75rem 1.5rem;
      color: white;
      font-weight: 700;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    .submit-btn:hover {
      background: linear-gradient(45deg, var(--secondary-teal), var(--primary-teal));
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .promotions-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .promotions-table th,
    .promotions-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #e0f7fa;
    }

    .promotions-table th {
      background: var(--primary-teal);
      color: white;
      font-weight: 700;
    }

    .promotions-table tr:hover {
      background: #e0f7fa;
    }

    .promotion-image {
      width: 100px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
    }

    .action-btn {
      background: linear-gradient(45deg, var(--gold), var(--gold-light));
      border: none;
      padding: 0.5rem 1rem;
      color: var(--dark);
      font-weight: 600;
      font-size: 0.9rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 0.5rem;
    }

    .action-btn:hover {
      background: linear-gradient(45deg, var(--gold-light), #ffb300);
      transform: translateY(-1px);
    }

    .error-message {
      color: var(--error-red);
      font-size: 0.9rem;
      margin-top: 0.5rem;
      display: none;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow-md);
      animation: slideUp 0.3s ease-out;
    }

    .modal-content h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-teal);
      margin-bottom: 1rem;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.2rem;
      color: var(--dark);
      position: absolute;
      top: 1rem;
      right: 1rem;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .close-btn:hover {
      color: var(--primary-teal);
    }

    #toast {
      visibility: hidden;
      min-width: 180px;
      max-width: 90%;
      background: linear-gradient(45deg, #4caf50, #66bb6a);
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 0.8rem;
      position: fixed;
      z-index: 1000;
      top: 60px;
      right: 10px;
      font-size: 0.85rem;
      box-shadow: var(--shadow-sm);
      font-family: Arial, sans-serif;
    }

    #toast.show {
      visibility: visible;
      animation: slideDown 0.4s ease-out, slideUp 0.4s ease-in 2s forwards;
    }

    .current-image {
      max-width: 100px;
      margin-top: 10px;
      border-radius: 4px;
    }

    @keyframes shine {
      0% { left: -100%; }
      50% { left: 100%; }
      100% { left: 100%; }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideDown {
      from { opacity: 0; top: -100%; }
      to { opacity: 1; top: 60px; }
    }

    @keyframes slideUp {
      from { opacity: 1; top: 60px; }
      to { opacity: 0; top: -100%; }
    }

    @media (max-width: 480px) {
      header img { height: 45px; }
      header h1 { font-size: 1.8rem; }
      header span { font-size: 0.8rem; }
      nav a { font-size: 0.9rem; padding: 0.8rem; flex: 0 1 100px; }
      .logout { padding: 0.5rem 1rem; font-size: 0.9rem; }
      .content { margin: 1rem; padding: 1rem; }
      .content h2 { font-size: 1.6rem; }
      .form-container { padding: 1rem; }
      .promotions-table { font-size: 0.9rem; }
      .promotion-image { width: 80px; height: 48px; }
      .action-btn { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
      .modal-content { padding: 1rem; }
      #toast { font-size: 0.7rem; padding: 0.7rem; top: 50px; }
    }
  </style>
</head>
<body>
  <div id="toast"></div>

  <header>
    <img src="https://i.postimg.cc/W3pgQx9q/DELICUTE-Imgur-1-modified.png" alt="DELICUTE Logo">
    <div>
      <h1>DELICUTE</h1>
      <span>Every Bite Tells A Story</span>
    </div>
    <button class="logout" onclick="logout()">Logout</button>
  </header>

  <nav>
    <a href="adminorders.html">Orders</a>
    <a href="adminmenu.html">Menu</a>
    <a href="admincoupons.html">Coupons</a>
    <a href="admincategories.html">Categories</a>
    <a href="admintoppicks.html">Top Picks</a>
    <a href="adminpromotions.html">Promotions</a>
  </nav>

  <div class="content">
    <h2>Manage Promotions</h2>
    <div class="form-container">
      <form id="promotion-form">
        <div class="form-group">
          <label for="title">Promotion Title</label>
          <input type="text" id="title" name="title" required>
          <div class="error-message" id="title-error">Please enter a valid title.</div>
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" required></textarea>
          <div class="error-message" id="description-error">Please enter a description.</div>
        </div>
        <div class="form-group">
          <label for="image">Promotion Image</label>
          <input type="file" id="image" name="image" accept="image/*" required>
          <div class="error-message" id="image-error">Please select an image.</div>
        </div>
        <div class="form-group">
          <label for="start-date">Start Date & Time</label>
          <input type="datetime-local" id="start-date" name="start_date" required>
          <div class="error-message" id="start-date-error">Please select a valid start date and time.</div>
        </div>
        <div class="form-group">
          <label for="end-date">End Date & Time</label>
          <input type="datetime-local" id="end-date" name="end_date" required>
          <div class="error-message" id="end-date-error">Please select a valid end date and time.</div>
        </div>
        <button type="submit" class="submit-btn">Add Promotion</button>
      </form>
    </div>

    <table class="promotions-table">
      <thead>
        <tr>
          <th>Title</th>
          <th>Description</th>
          <th>Image</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="promotions-list"></tbody>
    </table>
  </div>

  <div class="modal" id="edit-modal">
    <div class="modal-content">
      <h3>Edit Promotion</h3>
      <button class="close-btn" onclick="closeEditModal()">✕</button>
      <form id="edit-promotion-form">
        <div class="form-group">
          <label for="edit-title">Promotion Title</label>
          <input type="text" id="edit-title" name="title" required>
          <div class="error-message" id="edit-title-error">Please enter a valid title.</div>
        </div>
        <div class="form-group">
          <label for="edit-description">Description</label>
          <textarea id="edit-description" name="description" required></textarea>
          <div class="error-message" id="edit-description-error">Please enter a description.</div>
        </div>
        <div class="form-group">
          <label for="edit-image">Promotion Image</label>
          <input type="file" id="edit-image" name="image" accept="image/*">
          <div class="error-message" id="edit-image-error">Please select a valid image.</div>
          <img id="current-image" class="current-image" src="" alt="Current Promotion Image" style="display: none;">
        </div>
        <div class="form-group">
          <label for="edit-start-date">Start Date & Time</label>
          <input type="datetime-local" id="edit-start-date" name="start_date" required>
          <div class="error-message" id="edit-start-date-error">Please select a valid start date and time.</div>
        </div>
        <div class="form-group">
          <label for="edit-end-date">End Date & Time</label>
          <input type="datetime-local" id="edit-end-date" name="end_date" required>
          <div class="error-message" id="edit-end-date-error">Please select a valid end date and time.</div>
        </div>
        <button type="submit" class="submit-btn">Update Promotion</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // Toast Notification Function
    function showToast(msg, success = true) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.style.background = success 
        ? "linear-gradient(45deg, #4caf50, #66bb6a)" 
        : "linear-gradient(45deg, #f44336, #ef5350)";
      toast.className = "show";
      setTimeout(() => toast.className = toast.className.replace("show", ""), 2000);
    }

    // Authentication Check
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const response = await fetch("/api/auth/check", { 
          credentials: "include",
          cache: "no-store"
        });
        if (!response.ok) {
          showToast("Authentication failed. Redirecting to login.", false);
          setTimeout(() => window.location.href = "/admin.html", 2000);
        }
      } catch (error) {
        console.error("Auth Check Error:", error);
        showToast("Authentication failed: " + error.message, false);
        setTimeout(() => window.location.href = "/admin.html", 2000);
      }
    });

    // Logout Function
    async function logout() {
      try {
        const response = await fetch("/api/auth/logout", { 
          method: "POST", 
          credentials: "include",
          cache: "no-store"
        });
        if (response.ok) {
          showToast("Logged out successfully!", true);
          setTimeout(() => window.location.href = "/admin.html", 1000);
        } else {
          throw new Error("Logout failed");
        }
      } catch (error) {
        console.error("Logout Error:", error);
        showToast("Logout failed: " + error.message, false);
      }
    }

    // WebSocket Setup
    const socket = io({
      auth: { token: localStorage.getItem("token") || getCookie("token") },
      reconnectionAttempts: 3,
      timeout: 5000
    });

    socket.on("connect", () => console.log("WebSocket connected:", socket.id));
    socket.on("new-promotion", () => fetchPromotions());
    socket.on("connect_error", (err) => {
      console.error("WebSocket Error:", err);
      showToast("WebSocket connection failed", false);
    });

    // Utility: Get Cookie
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      return parts.length === 2 ? parts.pop().split(";").shift() : null;
    }

    // Elements
    const promotionForm = document.getElementById("promotion-form");
    const promotionsList = document.getElementById("promotions-list");
    const editModal = document.getElementById("edit-modal");
    const editForm = document.getElementById("edit-promotion-form");

    // Fetch Promotions
    async function fetchPromotions() {
      try {
        const response = await fetch("/api/promotions", { 
          credentials: "include",
          cache: "no-store"
        });
        const { success, data, message } = await response.json();
        if (!success) throw new Error(message);
        renderPromotions(data);
      } catch (err) {
        console.error("Fetch Promotions Error:", err);
        showToast("Failed to fetch promotions: " + err.message, false);
      }
    }

    // Render Promotions
    function renderPromotions(promotions) {
      promotionsList.innerHTML = promotions.length
        ? promotions.map(p => {
            // Escape quotes and special characters for JavaScript string literals
            const safeTitle = p.title.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const safeDescription = p.description.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            return `
              <tr>
                <td>${escapeHtml(p.title)}</td>
                <td>${escapeHtml(p.description)}</td>
                <td><img src="${p.image}" alt="${escapeHtml(p.title)}" class="promotion-image" loading="lazy" onerror="this.src='https://via.placeholder.com/100x60'"></td>
                <td>${new Date(p.start_date).toLocaleString()}</td>
                <td>${new Date(p.end_date).toLocaleString()}</td>
                <td>
                  <button class="action-btn" onclick="openEditModal(${p.id}, '${safeTitle}', '${safeDescription}', '${p.image}', '${p.start_date}', '${p.end_date}')">Edit</button>
                  <button class="action-btn" onclick="deletePromotion(${p.id})">Delete</button>
                </td>
              </tr>
            `;
          }).join("")
        : '<tr><td colspan="6" style="text-align: center;">No promotions available</td></tr>';
    }

    // HTML Escape Utility
    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // Add Promotion
    promotionForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(promotionForm);
      const startDate = new Date(formData.get("start_date"));
      const endDate = new Date(formData.get("end_date"));

      // Client-side validation
      document.querySelectorAll(".error-message").forEach(e => e.style.display = "none");
      let isValid = true;
      if (!formData.get("title").trim()) {
        document.getElementById("title-error").style.display = "block";
        isValid = false;
      }
      if (!formData.get("description").trim()) {
        document.getElementById("description-error").style.display = "block";
        isValid = false;
      }
      if (!formData.get("image").size) {
        document.getElementById("image-error").style.display = "block";
        isValid = false;
      }
      if (!formData.get("start_date")) {
        document.getElementById("start-date-error").style.display = "block";
        isValid = false;
      }
      if (!formData.get("end_date") || endDate <= startDate) {
        document.getElementById("end-date-error").style.display = "block";
        isValid = false;
      }
      if (!isValid) {
        showToast("Please correct the form errors", false);
        return;
      }

      try {
        const response = await fetch("/api/promotions", {
          method: "POST",
          body: formData,
          credentials: "include"
        });
        const { success, message } = await response.json();
        if (!success) throw new Error(message);
        promotionForm.reset();
        fetchPromotions();
        showToast("Promotion added successfully!", true);
      } catch (err) {
        console.error("Add Promotion Error:", err);
        showToast("Failed to add promotion: " + err.message, false);
      }
    });

    // Open Edit Modal
    function openEditModal(id, title, description, image, startDate, endDate) {
      try {
        const editTitle = document.getElementById("edit-title");
        const editDescription = document.getElementById("edit-description");
        const editStartDate = document.getElementById("edit-start-date");
        const editEndDate = document.getElementById("edit-end-date");
        const currentImage = document.getElementById("current-image");

        // Clear previous values and errors
        editForm.reset();
        document.querySelectorAll(".error-message").forEach(e => e.style.display = "none");

        // Populate form fields
        editTitle.value = title;
        editDescription.value = description;
        editStartDate.value = new Date(startDate).toISOString().slice(0, 16);
        editEndDate.value = new Date(endDate).toISOString().slice(0, 16);
        editForm.dataset.id = id;

        // Display current image
        currentImage.src = image;
        currentImage.style.display = image ? "block" : "none";

        // Show modal
        editModal.classList.add("show");
      } catch (err) {
        console.error("Open Edit Modal Error:", err);
        showToast("Failed to open edit modal: " + err.message, false);
      }
    }

    // Close Edit Modal
    function closeEditModal() {
      editModal.classList.remove("show");
      editForm.reset();
      delete editForm.dataset.id;
      document.getElementById("current-image").style.display = "none";
      document.querySelectorAll(".error-message").forEach(e => e.style.display = "none");
    }

    // Update Promotion
    editForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = editForm.dataset.id;
      const formData = new FormData(editForm);
      const startDate = new Date(formData.get("start_date"));
      const endDate = new Date(formData.get("end_date"));

      // Client-side validation
      document.querySelectorAll(".error-message").forEach(e => e.style.display = "none");
      let isValid = true;
      if (!formData.get("title").trim()) {
        document.getElementById("edit-title-error").style.display = "block";
        isValid = false;
      }
      if (!formData.get("description").trim()) {
        document.getElementById("edit-description-error").style.display = "block";
        isValid = false;
      }
      if (!formData.get("start_date")) {
        document.getElementById("edit-start-date-error").style.display = "block";
        isValid = false;
      }
      if (!formData.get("end_date") || endDate <= startDate) {
        document.getElementById("edit-end-date-error").style.display = "block";
        isValid = false;
      }
      if (!isValid) {
        showToast("Please correct the form errors", false);
        return;
      }

      try {
        const response = await fetch(`/api/promotions/${id}`, {
          method: "PUT",
          body: formData,
          credentials: "include"
        });
        const { success, message } = await response.json();
        if (!success) throw new Error(message);
        closeEditModal();
        fetchPromotions();
        showToast("Promotion updated successfully!", true);
      } catch (err) {
        console.error("Update Promotion Error:", err);
        showToast("Failed to update promotion: " + err.message, false);
      }
    });

    // Delete Promotion
    async function deletePromotion(id) {
      if (!confirm("Are you sure you want to delete this promotion?")) return;
      try {
        const response = await fetch(`/api/promotions/${id}`, {
          method: "DELETE",
          credentials: "include",
          cache: "no-store"
        });
        const { success, message } = await response.json();
        if (!success) throw new Error(message);
        fetchPromotions();
        showToast("Promotion deleted successfully!", true);
      } catch (err) {
        console.error("Delete Promotion Error:", err);
        showToast("Failed to delete promotion: " + err.message, false);
      }
    }

    // Initial Fetch
    fetchPromotions();
  </script>
</body>
</html>