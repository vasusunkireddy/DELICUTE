<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Delicute | Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #fef7f2 0%, #ffece5 100%);
      color: #1a1a1a;
      min-height: 100vh;
      line-height: 1.5;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 1.5rem auto;
      padding: 0 1rem;
    }

    .header {
      text-align: center;
      padding: 2rem 0;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      backdrop-filter: blur(12px);
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,231,224,0.3) 100%);
      z-index: 0;
    }

    .header img {
      width: 120px;
      opacity: 0;
      transform: scale(0.8);
      animation: fadeInScale 1s ease-out forwards;
      position: relative;
      z-index: 1;
    }

    .header h1 {
      font-family: 'Playfair Display', serif;
      font-size: 3.5rem;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 0.75rem;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.8s ease-out 0.2s forwards;
      position: relative;
      z-index: 1;
    }

    .nav-tabs {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .nav-tabs button {
      background: none;
      border: none;
      font-family: 'Roboto', sans-serif;
      font-size: 0.95rem;
      font-weight: 500;
      color: #4a4a4a;
      cursor: pointer;
      padding: 0.7rem 1.4rem;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .nav-tabs button.active {
      background: #ff6200;
      color: #ffffff;
      font-weight: 600;
    }

    .nav-tabs button:hover {
      background: rgba(255, 98, 0, 0.1);
      color: #d45200;
    }

    .tab-content {
      display: none;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      backdrop-filter: blur(12px);
      opacity: 0;
      transform: translateY(15px);
      animation: fadeInUp 0.5s ease-out forwards;
    }

    .tab-content.active {
      display: block;
    }

    .error-message, .success-message {
      display: none;
      padding: 0.8rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      text-align: center;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .error-message {
      background: rgba(239, 83, 80, 0.1);
      color: #d32f2f;
    }

    .success-message {
      background: rgba(46, 125, 50, 0.1);
      color: #2e7d32;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 1rem;
      table-layout: fixed;
    }

    th, td {
      padding: 0.7rem;
      text-align: left;
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    th {
      font-weight: 600;
      color: #2c2c2c;
      background: rgba(255, 255, 255, 0.2);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: #2c2c2c;
      margin-bottom: 0.4rem;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 8px;
      font-size: 0.9rem;
      background: rgba(255, 255, 255, 0.6);
      transition: all 0.3s ease;
      font-family: 'Roboto', sans-serif;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #ff6200;
      box-shadow: 0 0 0 2px rgba(255, 98, 0, 0.2);
    }

    .btn {
      background: linear-gradient(45deg, #ff6200, #ff8c00);
      color: #ffffff;
      padding: 0.7rem 1.4rem;
      font-size: 0.9rem;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(255, 98, 0, 0.3);
    }

    .btn:hover {
      background: linear-gradient(45deg, #d45200, #ff6200);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 98, 0, 0.4);
    }

    .btn-danger {
      background: linear-gradient(45deg, #ef5350, #ff8a80);
      box-shadow: 0 2px 10px rgba(239, 83, 80, 0.3);
    }

    .btn-danger:hover {
      background: linear-gradient(45deg, #d32f2f, #ef5350);
      box-shadow: 0 4px 12px rgba(239, 83, 80, 0.4);
    }

    .btn-secondary {
      background: rgba(0, 0, 0, 0.05);
      color: #2c2c2c;
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: rgba(0, 0, 0, 0.1);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .menu-item, .coupon-item {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      vertical-align: middle;
    }

    .saved-amount {
      display: inline-block;
      background: #2e7d32;
      color: #ffffff;
      padding: 0.3rem 0.5rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(12px);
    }

    .modal-content h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 1rem;
    }

    .close-btn {
      float: right;
      font-size: 1.2rem;
      cursor: pointer;
      color: #4a4a4a;
      transition: color 0.3s ease;
    }

    .close-btn:hover {
      color: #1a1a1a;
    }

    .empty-message {
      text-align: center;
      padding: 0.8rem;
      color: #4a4a4a;
      font-style: italic;
      font-size: 0.9rem;
    }

    .order-details {
      margin-bottom: 0.8rem;
    }

    .order-details p {
      margin: 0.4rem 0;
      font-size: 0.9rem;
    }

    .order-details strong {
      color: #2c2c2c;
      font-weight: 600;
    }

    .order-details ul {
      list-style: none;
      padding: 0;
      margin: 0.4rem 0;
    }

    .order-details ul li {
      padding: 0.3rem 0;
      font-size: 0.9rem;
    }

    .order-link {
      color: #ff6200;
      cursor: pointer;
      text-decoration: underline;
    }

    .order-link:hover {
      color: #d45200;
    }

    /* Table column widths */
    #menu-table th:nth-child(1), #menu-table td:nth-child(1) { width: 60px; }
    #menu-table th:nth-child(2), #menu-table td:nth-child(2) { width: 25%; }
    #menu-table th:nth-child(3), #menu-table td:nth-child(3) { width: 20%; }
    #menu-table th:nth-child(4), #menu-table td:nth-child(4) { width: 15%; }
    #menu-table th:nth-child(5), #menu-table td:nth-child(5) { width: 15%; }
    #menu-table th:nth-child(6), #menu-table td:nth-child(6) { width: 25%; }

    #coupons-table th:nth-child(1), #coupons-table td:nth-child(1) { width: 60px; }
    #coupons-table th:nth-child(2), #coupons-table td:nth-child(2) { width: 15%; }
    #coupons-table th:nth-child(3), #coupons-table td:nth-child(3) { width: 25%; }
    #coupons-table th:nth-child(4), #coupons-table td:nth-child(4) { width: 10%; }
    #coupons-table th:nth-child(5), #coupons-table td:nth-child(5) { width: 15%; }
    #coupons-table th:nth-child(6), #coupons-table td:nth-child(6) { width: 15%; }
    #coupons-table th:nth-child(7), #coupons-table td:nth-child(7) { width: 15%; }
    #coupons-table th:nth-child(8), #coupons-table td:nth-child(8) { width: 20%; }

    #top-picks-table th:nth-child(1), #top-picks-table td:nth-child(1) { width: 60px; }
    #top-picks-table th:nth-child(2), #top-picks-table td:nth-child(2) { width: 35%; }
    #top-picks-table th:nth-child(3), #top-picks-table td:nth-child(3) { width: 30%; }
    #top-picks-table th:nth-child(4), #top-picks-table td:nth-child(4) { width: 25%; }

    @keyframes fadeInScale {
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 0 0.8rem;
      }

      .header h1 {
        font-size: 2.5rem;
      }

      .nav-tabs {
        gap: 0.6rem;
      }

      .nav-tabs button {
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
      }

      table {
        font-size: 0.85rem;
      }

      th, td {
        padding: 0.5rem;
      }

      .orders-table, #menu-table, #coupons-table, #top-picks-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      .btn {
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
      }
    }

    @media (max-width: 480px) {
      .header img {
        width: 90px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .tab-content {
        padding: 1rem;
      }

      .modal-content {
        padding: 1rem;
        width: 95%;
      }

      .menu-item, .coupon-item {
        width: 32px;
        height: 32px;
      }

      .form-group input, .form-group select, .form-group textarea {
        font-size: 0.85rem;
        padding: 0.6rem;
      }

      .modal-content h2 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://i.postimg.cc/W3pgQx9q/DELICUTE-Imgur-1-modified.png" alt="Delicute Logo" />
      <h1>Delicute Admin Dashboard</h1>
    </div>
    <div class="nav-tabs">
      <button class="active" onclick="showTab('orders')">Orders</button>
      <button onclick="showTab('menu')">Menu</button>
      <button onclick="showTab('categories')">Categories</button>
      <button onclick="showTab('coupons')">Coupons</button>
      <button onclick="showTab('top-picks')">Top Picks</button>
      <button onclick="logout()">Logout</button>
    </div>
    <div id="error-message" class="error-message"></div>
    <div id="success-message" class="success-message"></div>

    <!-- Orders Tab -->
    <div id="orders" class="tab-content active">
      <h2>Orders</h2>
      <table id="orders-table" class="orders-table">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Table Number</th>
            <th>Items</th>
            <th>Special Instructions</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Menu Tab -->
    <div id="menu" class="tab-content">
      <h2>Menu Management</h2>
      <button class="btn" onclick="openMenuModal('add')">Add New Item</button>
      <table id="menu-table">
        <thead>
          <tr>
            <th>Image</th>
            <th>Name</th>
            <th>Category</th>
            <th>Price (₹)</th>
            <th>Saved Amount (₹)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Categories Tab -->
    <div id="categories" class="tab-content">
      <h2>Category Management</h2>
      <button class="btn" onclick="openCategoryModal('add')">Add New Category</button>
      <table id="categories-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Coupons Tab -->
    <div id="coupons" class="tab-content">
      <h2>Coupon Management</h2>
      <button class="btn" onclick="openCouponModal('add')">Add New Coupon</button>
      <table id="coupons-table">
        <thead>
          <tr>
            <th>Image</th>
            <th>Code</th>
            <th>Description</th>
            <th>Quantity</th>
            <th>Category</th>
            <th>Valid From</th>
            <th>Valid To</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Top Picks Tab -->
    <div id="top-picks" class="tab-content">
      <h2>Top Picks Management</h2>
      <button class="btn" onclick="openTopPicksModal()">Add Top Pick</button>
      <table id="top-picks-table">
        <thead>
          <tr>
            <th>Image</th>
            <th>Name</th>
            <th>Category</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Order Details Modal -->
    <div id="order-details-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('order-details-modal')">×</span>
        <h2>Order Details</h2>
        <div id="order-details-content" class="order-details"></div>
        <div class="form-group">
          <button class="btn btn-secondary" onclick="closeModal('order-details-modal')">Close</button>
        </div>
      </div>
    </div>

    <!-- Menu Modal -->
    <div id="menu-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('menu-modal')">×</span>
        <h2 id="menu-modal-title">Add Menu Item</h2>
        <form id="menu-form" enctype="multipart/form-data">
          <div class="form-group">
            <label for="menu-name">Name</label>
            <input type="text" id="menu-name" required />
          </div>
          <div class="form-group">
            <label for="menu-description">Description</label>
            <textarea id="menu-description" rows="4" required></textarea>
          </div>
          <div class="form-group">
            <label for="menu-category">Category</label>
            <select id="menu-category" required></select>
          </div>
          <div class="form-group">
            <label for="menu-price">Original Price (₹)</label>
            <input type="number" id="menu-price" step="0.01" min="0" required />
          </div>
          <div class="form-group">
            <label for="menu-saved-amount">Saved Amount (₹, Optional)</label>
            <input type="number" id="menu-saved-amount" step="0.01" min="0" />
          </div>
          <div class="form-group">
            <label for="menu-image">Image</label>
            <input type="file" id="menu-image" accept="image/*" />
            <input type="hidden" id="menu-existing-image" />
          </div>
          <div class="form-group">
            <button type="submit" class="btn">Save Item</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('menu-modal')">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Category Modal -->
    <div id="category-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('category-modal')">×</span>
        <h2 id="category-modal-title">Add Category</h2>
        <form id="category-form">
          <div class="form-group">
            <label for="category-name">Category Name</label>
            <input type="text" id="category-name" required />
          </div>
          <div class="form-group">
            <button type="submit" class="btn">Save Category</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('category-modal')">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Coupon Modal -->
    <div id="coupon-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('coupon-modal')">×</span>
        <h2 id="coupon-modal-title">Add Coupon</h2>
        <form id="coupon-form" enctype="multipart/form-data">
          <div class="form-group">
            <label for="coupon-code">Coupon Code</label>
            <input type="text" id="coupon-code" required />
          </div>
          <div class="form-group">
            <label for="coupon-description">Description</label>
            <textarea id="coupon-description" rows="4" required></textarea>
          </div>
          <div class="form-group">
            <label for="coupon-buy-x">Quantity (e.g., Buy X items)</label>
            <input type="number" id="coupon-buy-x" min="1" required />
          </div>
          <div class="form-group">
            <label for="coupon-category">Category</label>
            <select id="coupon-category" required></select>
          </div>
          <div class="form-group">
            <label for="coupon-valid-from">Valid From</label>
            <input type="date" id="coupon-valid-from" required />
          </div>
          <div class="form-group">
            <label for="coupon-valid-to">Valid To</label>
            <input type="date" id="coupon-valid-to" required />
          </div>
          <div class="form-group">
            <label for="coupon-image">Image</label>
            <input type="file" id="coupon-image" accept="image/*" />
            <input type="hidden" id="coupon-existing-image" />
          </div>
          <div class="form-group">
            <button type="submit" class="btn">Save Coupon</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('coupon-modal')">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Top Picks Modal -->
    <div id="top-picks-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('top-picks-modal')">×</span>
        <h2>Add Top Pick</h2>
        <form id="top-picks-form">
          <div class="form-group">
            <label for="top-pick-item">Menu Item</label>
            <select id="top-pick-item" required></select>
          </div>
          <div class="form-group">
            <button type="submit" class="btn">Add Top Pick</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('top-picks-modal')">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://delicute-3bf1.onrender.com';
    const PLACEHOLDER_IMAGE = '/public/images/placeholder.jpg';

    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.nav-tabs button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.nav-tabs button[onclick="showTab('${tabId}')"]`).classList.add('active');
      clearMessages();
      if (tabId === 'orders') fetchOrders();
      else if (tabId === 'menu') fetchMenu();
      else if (tabId === 'categories') fetchCategories();
      else if (tabId === 'coupons') fetchCoupons();
      else if (tabId === 'top-picks') fetchTopPicks();
    }

    function clearMessages() {
      document.getElementById('error-message').style.display = 'none';
      document.getElementById('success-message').style.display = 'none';
    }

    function showError(message) {
      const errorMessage = document.getElementById('error-message');
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      setTimeout(clearMessages, 5000);
    }

    function showSuccess(message) {
      const successMessage = document.getElementById('success-message');
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      setTimeout(clearMessages, 5000);
    }

    async function fetchOrders() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/orders`, { credentials: 'include' });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.message || 'Failed to fetch orders');
        }

        const orders = result.data;
        const tbody = document.querySelector('#orders-table tbody');
        tbody.innerHTML = '';
        if (!Array.isArray(orders) || orders.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="empty-message">No orders available</td></tr>';
          return;
        }

        orders.forEach(order => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><span class="order-link" onclick="openOrderDetailsModal('${order.orderId}')">${order.orderId}</span></td>
            <td>${order.customer.name}</td>
            <td>${order.tableNumber || 'N/A'}</td>
            <td>${order.items.map(item => `${item.name} (x${item.quantity})`).join(', ')}</td>
            <td>${order.specialInstructions || 'None'}</td>
            <td>${order.status}</td>
            <td><button class="btn" onclick="updateOrderStatus('${order.orderId}', 'Delivered')">Mark Delivered</button></td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        showError(error.message);
      }
    }

    async function openOrderDetailsModal(orderId) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/orders/${orderId}`, { credentials: 'include' });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.message || 'Failed to fetch order details');
        }

        const order = result.data;
        const content = document.getElementById('order-details-content');
        content.innerHTML = `
          <p><strong>Order ID:</strong> ${order.orderId}</p>
          <p><strong>Customer Name:</strong> ${order.customer.name}</p>
          <p><strong>Table Number:</strong> ${order.tableNumber || 'N/A'}</p>
          <p><strong>Order Date:</strong> ${new Date(order.createdAt).toLocaleString()}</p>
          <p><strong>Status:</strong> ${order.status}</p>
          <p><strong>Special Instructions:</strong> ${order.specialInstructions || 'None'}</p>
          <p><strong>Items:</strong></p>
          <ul>
            ${order.items.map(item => `
              <li>${item.name} (x${item.quantity}) - ₹${Number(item.price).toFixed(2)}</li>
            `).join('')}
          </ul>
          <p><strong>Total Amount:</strong> ₹${order.items.reduce((total, item) => total + Number(item.price) * item.quantity, 0).toFixed(2)}</p>
        `;
        document.getElementById('order-details-modal').style.display = 'flex';
      } catch (error) {
        showError(error.message);
      }
    }

    async function fetchMenu() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/menu`, { credentials: 'include' });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.message || 'Failed to fetch menu');
        }

        const menu = result.data;
        const tbody = document.querySelector('#menu-table tbody');
        tbody.innerHTML = '';
        if (!Array.isArray(menu) || menu.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-message">No menu items available</td></tr>';
          return;
        }

        menu.forEach(item => {
          const price = Number(item.price);
          const savedAmount = item.savedAmount !== null ? Number(item.savedAmount) : null;
          const formattedPrice = isNaN(price) ? 'N/A' : `₹${price.toFixed(2)}`;
          const formattedSavedAmount = savedAmount === null || isNaN(savedAmount) ? 'N/A' : `Save ₹${savedAmount.toFixed(2)}`;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><img src="${item.image || PLACEHOLDER_IMAGE}" alt="${item.name}" class="menu-item" onerror="this.src='${PLACEHOLDER_IMAGE}'" /></td>
            <td>${item.name}</td>
            <td>${item.category}</td>
            <td>${formattedPrice}</td>
            <td>${formattedSavedAmount}</td>
            <td>
              <button class="btn btn-secondary" onclick="openMenuModal('edit', '${item._id}')">Edit</button>
              <button class="btn btn-danger" onclick="deleteMenuItem('${item._id}')">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        showError(error.message);
      }
    }

    async function fetchCategories() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/categories`, { credentials: 'include' });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.message || 'Failed to fetch categories');
        }

        const categories = result.data;
        const tbody = document.querySelector('#categories-table tbody');
        tbody.innerHTML = '';
        if (!Array.isArray(categories) || categories.length === 0) {
          tbody.innerHTML = '<tr><td colspan="2" class="empty-message">No categories available</td></tr>';
        } else {
          categories.forEach(category => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${category.name}</td>
              <td>
                <button class="btn btn-secondary" onclick="openCategoryModal('edit', '${category._id}')">Edit</button>
                <button class="btn btn-danger" onclick="deleteCategory('${category._id}')">Delete</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }

        // Populate category dropdowns
        const menuCategorySelect = document.getElementById('menu-category');
        const couponCategorySelect = document.getElementById('coupon-category');
        menuCategorySelect.innerHTML = '<option value="">Select Category</option>';
        couponCategorySelect.innerHTML = '<option value="">Select Category</option>';
        if (Array.isArray(categories)) {
          categories.forEach(category => {
            menuCategorySelect.innerHTML += `<option value="${category.name}">${category.name}</option>`;
            couponCategorySelect.innerHTML += `<option value="${category.name}">${category.name}</option>`;
          });
        }
      } catch (error) {
        showError(error.message);
      }
    }

    async function fetchCoupons() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/coupons`, { credentials: 'include' });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.message || 'Failed to fetch coupons');
        }

        const coupons = result.data;
        const tbody = document.querySelector('#coupons-table tbody');
        tbody.innerHTML = '';
        if (!Array.isArray(coupons) || coupons.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="empty-message">No active coupons available</td></tr>';
          return;
        }

        coupons.forEach(coupon => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><img src="${coupon.image || PLACEHOLDER_IMAGE}" alt="${coupon.code}" class="coupon-item" onerror="this.src='${PLACEHOLDER_IMAGE}'" /></td>
            <td>${coupon.code}</td>
            <td>${coupon.description}</td>
            <td>Buy ${coupon.buy_x}</td>
            <td>${coupon.category}</td>
            <td>${new Date(coupon.validFrom).toLocaleDateString()}</td>
            <td>${new Date(coupon.validTo).toLocaleDateString()}</td>
            <td>
              <button class="btn btn-secondary" onclick="openCouponModal('edit', '${coupon._id}')">Edit</button>
              <button class="btn btn-danger" onclick="deleteCoupon('${coupon._id}')">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        showError(error.message);
      }
    }

    async function fetchTopPicks() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/top-picks`, { credentials: 'include' });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.message || 'Failed to fetch top picks');
        }

        const topPicks = result.data;
        const tbody = document.querySelector('#top-picks-table tbody');
        tbody.innerHTML = '';
        if (!Array.isArray(topPicks) || topPicks.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="empty-message">No top picks available</td></tr>';
        } else {
          topPicks.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><img src="${item.image || PLACEHOLDER_IMAGE}" alt="${item.name}" class="menu-item" onerror="this.src='${PLACEHOLDER_IMAGE}'" /></td>
              <td>${item.name}</td>
              <td>${item.category}</td>
              <td><button class="btn btn-danger" onclick="deleteTopPick('${item._id}')">Remove</button></td>
            `;
            tbody.appendChild(tr);
          });
        }

        // Populate top picks modal
        const responseMenu = await fetch(`${API_BASE_URL}/api/menu`, { credentials: 'include' });
        const menuResult = await responseMenu.json();
        if (!responseMenu.ok || !menuResult.success) {
          throw new Error(menuResult.message || 'Failed to fetch menu for top picks');
        }

        const menuItems = menuResult.data;
        const select = document.getElementById('top-pick-item');
        select.innerHTML = '<option value="">Select Item</option>';
        if (Array.isArray(menuItems)) {
          menuItems.forEach(item => {
            select.innerHTML += `<option value="${item._id}">${item.name}</option>`;
          });
        }
      } catch (error) {
        showError(error.message);
      }
    }

    async function openMenuModal(mode, id = '') {
      const modal = document.getElementById('menu-modal');
      const form = document.getElementById('menu-form');
      const title = document.getElementById('menu-modal-title');
      title.textContent = mode === 'add' ? 'Add Menu Item' : 'Edit Menu Item';
      form.dataset.mode = mode;
      form.dataset.id = id;

      // Make image optional for edit mode
      const imageInput = document.getElementById('menu-image');
      imageInput.required = mode === 'add';

      if (mode === 'edit') {
        try {
          const response = await fetch(`${API_BASE_URL}/api/menu/${id}`, { credentials: 'include' });
          const result = await response.json();
          if (!result.success) throw new Error(result.message || 'Failed to load menu item');
          const item = result.data;
          document.getElementById('menu-name').value = item.name || '';
          document.getElementById('menu-description').value = item.description || '';
          document.getElementById('menu-category').value = item.category || '';
          document.getElementById('menu-price').value = Number(item.price).toFixed(2) || '';
          document.getElementById('menu-saved-amount').value = item.savedAmount !== null ? Number(item.savedAmount).toFixed(2) : '';
          document.getElementById('menu-existing-image').value = item.image || '';
          modal.style.display = 'flex';
        } catch (error) {
          showError(error.message);
        }
      } else {
        form.reset();
        document.getElementById('menu-existing-image').value = '';
        modal.style.display = 'flex';
      }
    }

    async function openCouponModal(mode, id = '') {
      const modal = document.getElementById('coupon-modal');
      const form = document.getElementById('coupon-form');
      const title = document.getElementById('coupon-modal-title');
      title.textContent = mode === 'add' ? 'Add Coupon' : 'Edit Coupon';
      form.dataset.mode = mode;
      form.dataset.id = id;

      // Make image optional for edit mode
      const imageInput = document.getElementById('coupon-image');
      imageInput.required = mode === 'add';

      if (mode === 'edit') {
        try {
          const response = await fetch(`${API_BASE_URL}/api/coupons/${id}`, { credentials: 'include' });
          const result = await response.json();
          if (!result.success) throw new Error(result.message || 'Failed to load coupon');
          const coupon = result.data;
          document.getElementById('coupon-code').value = coupon.code || '';
          document.getElementById('coupon-description').value = coupon.description || '';
          document.getElementById('coupon-buy-x').value = coupon.buy_x || 1;
          document.getElementById('coupon-category').value = coupon.category || '';
          document.getElementById('coupon-valid-from').value = coupon.validFrom ? coupon.validFrom.split('T')[0] : '';
          document.getElementById('coupon-valid-to').value = coupon.validTo ? coupon.validTo.split('T')[0] : '';
          document.getElementById('coupon-existing-image').value = coupon.image || '';
          modal.style.display = 'flex';
        } catch (error) {
          showError(error.message);
        }
      } else {
        form.reset();
        document.getElementById('coupon-existing-image').value = '';
        modal.style.display = 'flex';
      }
    }

    function openCategoryModal(mode, id = '') {
      const modal = document.getElementById('category-modal');
      const form = document.getElementById('category-form');
      const title = document.getElementById('category-modal-title');
      title.textContent = mode === 'add' ? 'Add Category' : 'Edit Category';
      form.dataset.mode = mode;
      form.dataset.id = id;

      if (mode === 'edit') {
        fetch(`${API_BASE_URL}/api/categories/${id}`, { credentials: 'include' })
          .then(response => response.json())
          .then(result => {
            if (!result.success) throw new Error(result.message || 'Failed to load category');
            const category = result.data;
            document.getElementById('category-name').value = category.name || '';
            modal.style.display = 'flex';
          })
          .catch(error => showError(error.message));
      } else {
        form.reset();
        modal.style.display = 'flex';
      }
    }

    function openTopPicksModal() {
      document.getElementById('top-picks-modal').style.display = 'flex';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      clearMessages();
    }

    async function deleteMenuItem(id) {
      if (!confirm('Are you sure you want to delete this menu item?')) return;
      try {
        const response = await fetch(`${API_BASE_URL}/api/menu/${id}`, {
          method: 'DELETE',
          credentials: 'include',
        });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.message || 'Failed to delete menu item');
        }
        showSuccess('Menu item deleted successfully');
        fetchMenu();
      } catch (error) {
        showError(error.message);
      }
    }

    async function deleteCategory(id) {
      if (!confirm('Are you sure you want to delete this category?')) return;
      try {
        const response = await fetch(`${API_BASE_URL}/api/categories/${id}`, {
          method: 'DELETE',
          credentials: 'include',
        });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.message || 'Failed to delete category');
        }
        showSuccess('Category deleted successfully');
        fetchCategories();
      } catch (error) {
        showError(error.message);
      }
    }

    async function deleteCoupon(id) {
      if (!confirm('Are you sure you want to delete this coupon?')) return;
      try {
        const response = await fetch(`${API_BASE_URL}/api/coupons/${id}`, {
          method: 'DELETE',
          credentials: 'include',
        });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.message || 'Failed to delete coupon');
        }
        showSuccess('Coupon deleted successfully');
        fetchCoupons();
      } catch (error) {
        showError(error.message);
      }
    }

    async function deleteTopPick(id) {
      if (!confirm('Are you sure you want to remove this top pick?')) return;
      try {
        const response = await fetch(`${API_BASE_URL}/api/top-picks/${id}`, {
          method: 'DELETE',
          credentials: 'include',
        });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.message || 'Failed to remove top pick');
        }
        showSuccess('Top pick removed successfully');
        fetchTopPicks();
      } catch (error) {
        showError(error.message);
      }
    }

    async function updateOrderStatus(orderId, status) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/orders/${orderId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status }),
          credentials: 'include',
        });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.message || 'Failed to update order status');
        }
        showSuccess('Order status updated successfully');
        fetchOrders();
      } catch (error) {
        showError(error.message);
      }
    }

    async function handleMenuSubmit(event) {
      event.preventDefault();
      const form = event.target;
      const mode = form.dataset.mode;
      const id = form.dataset.id;
      const formData = new FormData();
      formData.append('name', document.getElementById('menu-name').value);
      formData.append('description', document.getElementById('menu-description').value);
      formData.append('category', document.getElementById('menu-category').value);
      formData.append('price', parseFloat(document.getElementById('menu-price').value));
      const savedAmount = document.getElementById('menu-saved-amount').value;
      if (savedAmount) formData.append('savedAmount', parseFloat(savedAmount));
      const imageFile = document.getElementById('menu-image').files[0];
      const existingImage = document.getElementById('menu-existing-image').value;
      if (imageFile) {
        formData.append('image', imageFile);
      } else if (existingImage && mode === 'edit') {
        formData.append('existingImage', existingImage);
      }

      try {
        const response = await fetch(`${API_BASE_URL}/api/menu${mode === 'edit' ? `/${id}` : ''}`, {
          method: mode === 'add' ? 'POST' : 'PUT',
          body: formData,
          credentials: 'include',
        });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.message || `Failed to ${mode} menu item`);
        }
        showSuccess(`Menu item ${mode === 'add' ? 'added' : 'updated'} successfully`);
        closeModal('menu-modal');
        fetchMenu();
      } catch (error) {
        showError(error.message);
      }
    }

    async function handleCouponSubmit(event) {
      event.preventDefault();
      const form = event.target;
      const mode = form.dataset.mode;
      const id = form.dataset.id;
      const formData = new FormData();
      formData.append('code', document.getElementById('coupon-code').value.toUpperCase());
      formData.append('description', document.getElementById('coupon-description').value);
      formData.append('buy_x', parseInt(document.getElementById('coupon-buy-x').value));
      formData.append('category', document.getElementById('coupon-category').value);
      formData.append('validFrom', document.getElementById('coupon-valid-from').value);
      formData.append('validTo', document.getElementById('coupon-valid-to').value);
      const imageFile = document.getElementById('coupon-image').files[0];
      const existingImage = document.getElementById('coupon-existing-image').value;
      if (imageFile) {
        formData.append('image', imageFile);
      } else if (existingImage && mode === 'edit') {
        formData.append('existingImage', existingImage);
      }

      try {
        const response = await fetch(`${API_BASE_URL}/api/coupons${mode === 'edit' ? `/${id}` : ''}`, {
          method: mode === 'add' ? 'POST' : 'PUT',
          body: formData,
          credentials: 'include',
        });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.message || `Failed to ${mode} coupon`);
        }
        showSuccess(`Coupon ${mode === 'add' ? 'added' : 'updated'} successfully`);
        closeModal('coupon-modal');
        fetchCoupons();
      } catch (error) {
        showError(error.message);
      }
    }

    async function handleCategorySubmit(event) {
      event.preventDefault();
      const form = event.target;
      const mode = form.dataset.mode;
      const id = form.dataset.id;
      const data = {
        name: document.getElementById('category-name').value,
      };

      try {
        const response = await fetch(`${API_BASE_URL}/api/categories${mode === 'edit' ? `/${id}` : ''}`, {
          method: mode === 'add' ? 'POST' : 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
          credentials: 'include',
        });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.message || `Failed to ${mode} category`);
        }
        showSuccess(`Category ${mode === 'add' ? 'added' : 'updated'} successfully`);
        closeModal('category-modal');
        fetchCategories();
      } catch (error) {
        showError(error.message);
      }
    }

    async function handleTopPicksSubmit(event) {
      event.preventDefault();
      const itemId = document.getElementById('top-pick-item').value;
      try {
        const response = await fetch(`${API_BASE_URL}/api/top-picks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ itemId }),
          credentials: 'include',
        });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.message || 'Failed to add top pick');
        }
        showSuccess('Top pick added successfully');
        closeModal('top-picks-modal');
        fetchTopPicks();
      } catch (error) {
        showError(error.message);
      }
    }

    function logout() {
      document.cookie = 'token=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/';
      window.location.href = '/admin.html';
    }

    document.getElementById('menu-form').addEventListener('submit', handleMenuSubmit);
    document.getElementById('category-form').addEventListener('submit', handleCategorySubmit);
    document.getElementById('coupon-form').addEventListener('submit', handleCouponSubmit);
    document.getElementById('top-picks-form').addEventListener('submit', handleTopPicksSubmit);

    // Initial load
    fetchOrders();
    fetchCategories();
  </script>
</body>
</html>